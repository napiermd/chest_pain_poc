<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chest Pain PoC — Realtime Risk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:flex;gap:12px;align-items:center;margin:8px 0;flex-wrap:wrap}
    textarea{width:100%;min-height:140px;padding:10px;font-size:15px}
    button{padding:10px 14px;border:0;border-radius:8px;background:#111;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600}
    .HIGH{background:#ffe5e5;color:#b00000}
    .MED{background:#fff5e0;color:#946200}
    .LOW{background:#e7ffe7;color:#196b19}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px}
    .line{border-top:1px solid #eee;margin:12px 0}
    .out{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:12px}
    .pill{padding:4px 8px;border-radius:999px;background:#f1f1f1;margin-right:6px;display:inline-block;font-size:12px}
    .ok{color:#196b19} .warn{color:#946200} .err{color:#b00000}
    .card{border:1px solid #eee;border-radius:10px;padding:10px;background:#fbfbfb}
    input[type=text]{width:100%;padding:8px 10px;font-size:14px;border:1px solid #ccc;border-radius:8px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <h1>Chest Pain PoC — Realtime Risk</h1>
  <div class="muted">Type/paste an HPI below, then click “Stream Demo” or “Predict Once”.</div>

  <div class="row">
    <button id="exHigh">Load High-risk Example</button>
    <button id="exLow">Load Low-risk Example</button>
    <span id="apiLabel" class="muted"></span>
    <span id="apiStatus" class="muted"></span>
    <button id="btnSettings" class="right">API Settings</button>
  </div>

  <div id="settings" class="card" style="display:none;margin:8px 0;">
    <div class="muted" style="margin-bottom:6px;">
      Set your API endpoint (e.g., <code>https://your-name.ngrok-free.dev/predict</code>). Saved in your browser.
    </div>
    <input id="apiInput" type="text" placeholder="https://.../predict">
    <div class="row" style="margin-top:8px;">
      <button id="btnSaveApi">Save</button>
      <button id="btnTestApi">Test</button>
      <span id="apiTestMsg" class="muted"></span>
    </div>
  </div>

  <textarea id="hpi"></textarea>

  <div class="row">
    <button id="stream">Stream Demo</button>
    <button id="predict">Predict Once</button>
  </div>

  <div class="line"></div>
  <div id="result" class="out">Output will appear here…</div>

  <script>
    // ------- API URL resolution (no code edits needed) -------
    function defaultApi() {
      // If you run the page locally (python -m http.server), default to localhost
      const isLocal =
        location.hostname === 'localhost' ||
        location.hostname === '127.0.0.1';
      return isLocal ? 'http://127.0.0.1:8001/predict' : '';
    }
    const q = new URLSearchParams(location.search);
    const fromQuery = q.get('api');                     // highest priority
    const fromStorage = localStorage.getItem('apiUrl'); // user-saved
    const fallback = defaultApi();                      // localhost if local
    let API = (fromQuery || fromStorage || fallback || '').trim();

    // Persist if provided via query
    if (fromQuery) localStorage.setItem('apiUrl', API);

    const elHpi = document.getElementById('hpi');
    const elOut = document.getElementById('result');
    const elApiLabel = document.getElementById('apiLabel');
    const elApiStatus = document.getElementById('apiStatus');
    const elSettings = document.getElementById('settings');
    const elApiInput = document.getElementById('apiInput');
    const elApiTestMsg = document.getElementById('apiTestMsg');

    function setApiLabel() {
      elApiLabel.textContent = API ? `API: ${API}` : 'API: not set';
    }
    setApiLabel();

    // Settings UI
    document.getElementById('btnSettings').onclick = () => {
      elSettings.style.display = elSettings.style.display === 'none' ? '' : 'none';
      elApiInput.value = API;
    };
    document.getElementById('btnSaveApi').onclick = () => {
      const val = elApiInput.value.trim();
      if (!val) return alert('Enter an API URL like https://.../predict');
      API = val;
      localStorage.setItem('apiUrl', API);
      setApiLabel();
      elApiTestMsg.textContent = 'Saved.';
      setTimeout(()=>elApiTestMsg.textContent='', 1200);
      // re-run health check
      checkHealth();
    };
    document.getElementById('btnTestApi').onclick = async () => {
      const val = elApiInput.value.trim();
      if (!val) return alert('Enter an API URL like https://.../predict');
      await checkHealth(val);
    };

    // Health check
    async function checkHealth(overrideApi) {
      const apiToUse = (overrideApi || API || '').trim();
      if (!apiToUse) {
        elApiStatus.innerHTML = ' | <span class="err">status: unreachable (no API set)</span>';
        return;
      }
      try {
        const base = apiToUse.replace(/\/predict\/?$/, '');
        const r = await fetch(base + '/health', { method:'GET' });
        if (!r.ok) throw new Error(`${r.status}`);
        const j = await r.json();
        elApiStatus.innerHTML = ` | <span class="${j.ok ? 'ok' : 'warn'}">status: ${j.ok ? 'online' : 'unknown'}</span>`;
        if (overrideApi) elApiTestMsg.textContent = 'Health OK.';
      } catch (e) {
        elApiStatus.innerHTML = ' | <span class="err">status: unreachable</span>';
        if (overrideApi) elApiTestMsg.textContent = 'Health FAILED.';
      }
      if (overrideApi) setTimeout(()=>elApiTestMsg.textContent='', 1500);
    }
    checkHealth();

    // Examples
    document.getElementById('exHigh').onclick = () => {
      elHpi.value = "55-year-old with exertional chest pressure radiating to jaw, diaphoresis, smoker.";
    };
    document.getElementById('exLow').onclick = () => {
      elHpi.value = "22-year-old with sharp pleuritic chest pain, reproducible to palpation. No dyspnea, no diaphoresis.";
    };

    // Predict-once
    document.getElementById('predict').onclick = async () => {
      const text = elHpi.value.trim();
      if (!text) return alert('Enter HPI text');
      if (!API) return alert('Set API in “API Settings” first.');
      try {
        const r = await fetch(API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({text})
        });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        const data = await r.json();
        renderOne(text, data);
      } catch (err) {
        elOut.textContent = `Request failed: ${err.message}\nHint: API must be reachable over HTTPS (ngrok/Render/etc).`;
      }
    };

    // Stream
    document.getElementById('stream').onclick = async () => {
      const full = elHpi.value.trim();
      if (!full) return alert('Enter HPI text');
      if (!API) return alert('Set API in “API Settings” first.');
      elOut.textContent = "Streaming…\n";
      const sents = full.split(/(?<=[.!?])\s+/);
      let sofar = "";
      for (let i=0;i<sents.length;i++){
        sofar = (sofar + " " + sents[i]).trim();
        try {
          const r = await fetch(API, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({text: sofar})
          });
          if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          const data = await r.json();
          appendStep(i+1, sents[i], data);
          await new Promise(res => setTimeout(res, 350));
        } catch (err) {
          elOut.textContent += `\nRequest failed: ${err.message}\nCheck your API URL.`;
          break;
        }
      }
    };

    function badge(band){ return `<span class="badge ${band}">${band}</span>`; }

    function renderOne(text, d){
      elOut.innerHTML =
`<div><strong>Result</strong> ${badge(d.band)}</div>
<div class="mono">P(ACS workup)=${d.prob.toFixed(3)}  |  pos_kw=${d.pos_kw_hits}  neg_kw=${d.neg_kw_hits}</div>
<div style="margin-top:8px;"><strong>What to ask next:</strong> ${d.ask_next.map(x=>`<span class="pill">${x}</span>`).join('') || '<span class="muted">none</span>'}</div>
<div class="line"></div>
<div><strong>Text</strong></div>
<div>${escapeHtml(text)}</div>`;
    }

    function appendStep(i, sent, d){
      elOut.innerHTML +=
`[${String(i).padStart(2,'0')}] ${escapeHtml(sent)}
  → P=${d.prob.toFixed(3)}  |  pos_kw=${d.pos_kw_hits}  neg_kw=${d.neg_kw_hits}  ${badge(d.band)} ${d.neg_kw_hits>0?'| lowering features noted':''}
${d.band!=='HIGH' && d.ask_next.length ? '  ask next: ' + d.ask_next.slice(0,3).join(', ') : ''}
\n`;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
